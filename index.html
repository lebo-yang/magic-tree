<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Hand Photo Tree</title>
  <style>
    body{margin:0;overflow:hidden;background:#050505;font-family:sans-serif;touch-action:none}
    #c{position:fixed;inset:0}
    #ui{position:fixed;inset:0;pointer-events:none;padding:14px;box-sizing:border-box;color:#FFD700;font:700 11px/1.2 monospace;text-shadow:0 0 10px rgba(255,215,0,.5)}
    #overlay{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:radial-gradient(circle,#1a1a1a 0%,#050505 100%);color:#FFD700;z-index:9;transition:opacity .35s}
    #btn{pointer-events:auto;padding:16px 42px;border:2px solid #FFD700;background:transparent;color:#FFD700;
      font-size:18px;border-radius:999px;font-weight:800}
    #err{display:none;margin-top:10px;color:#ff4b4b;font:600 12px/1.3 sans-serif;text-align:center;max-width:80vw}
    #up{position:fixed;left:50%;bottom:26px;transform:translateX(-50%);z-index:3;pointer-events:auto}
    #up label{display:inline-block;border:1px solid #FFD700;background:rgba(255,215,0,.12);color:#FFD700;
      padding:10px 18px;border-radius:999px;font-size:13px}
    #p{position:fixed;width:30px;height:30px;border:2px solid #FFD700;border-radius:50%;
      transform:translate(-50%,-50%);pointer-events:none;display:none;z-index:8;box-shadow:0 0 15px #FFD700}
    video{position:fixed;top:10px;right:10px;width:90px;height:120px;border-radius:8px;opacity:.28;
      transform:scaleX(-1);border:1px solid #FFD700;object-fit:cover;background:#000;pointer-events:none;z-index:2}
  </style>

  <!--
    é‡è¦ï¼ˆWi-Fi æ‰“ä¸å¼€/æŒ‰é’®æ²¡ååº”çš„æ ¹å› ï¼‰ï¼š
    ä½ å½“å‰ä¾èµ–å¤–éƒ¨ CDNï¼ˆunpkg/jsdelivrï¼‰ã€‚éƒ¨åˆ† Wi-Fi ä¼šæ‹¦æˆªè¿™äº›åŸŸåï¼Œå¯¼è‡´ type=module çš„ import å¤±è´¥ï¼Œ
    è¿›è€Œâ€œæŒ‰é’®æ— ååº”/åˆå§‹åŒ–ä¸æ‰§è¡Œâ€ã€‚

    æœ€ç¨³çš„æœ€ç»ˆè§£æ³•ï¼šæŠŠ threeã€mediapipe ç­‰æ–‡ä»¶ä¸‹è½½åˆ° GitHub Pages åŒåŸŸç›®å½•ï¼Œä¾‹å¦‚ï¼š
      /libs/three/three.module.js
      /libs/three/examples/jsm/...
      /libs/mediapipe/hands/hands.js
      /libs/mediapipe/camera_utils/camera_utils.js
    ç„¶åæŠŠä¸‹é¢çš„ CDN URL æ”¹ä¸ºç›¸å¯¹è·¯å¾„ï¼ˆåŒåŸŸåŠ è½½åŸºæœ¬ä¸ä¼šè¢« Wi-Fi æ‹¦æˆªï¼‰ã€‚
  -->
</head>

<body>
  <div id="overlay">
    <div style="font-size:28px;font-weight:900;margin-bottom:6px">ğŸ„ åœ£è¯æ‰‹åŠ¿ç›¸å†Œ ğŸ„</div>
    <div style="font-size:13px;opacity:.8;margin-bottom:18px">å»ºè®®ç«–å±ï¼Œå…‰çº¿å……è¶³</div>
    <button id="btn" type="button">å¼€å¯é­”æ³•</button>
    <div id="err"></div>
  </div>

  <!-- iOS Safariï¼šautoplay+muted+playsinline æ›´å®¹æ˜“å‡ºé¦–å¸§ -->
  <video id="v" playsinline autoplay muted></video>
  <div id="p"></div>

  <div id="ui">SYSTEM: <span id="st">INIT...</span></div>
  <div id="up">
    <label>ğŸ“¸ ä¸Šä¼ ç…§ç‰‡
      <input id="file" type="file" hidden multiple accept="image/*" />
    </label>
  </div>

  <div id="c"></div>

  <!-- MediaPipeï¼ˆåŒæ ·å»ºè®®æœªæ¥æ”¹ä¸ºåŒåŸŸè‡ªæ‰˜ç®¡ï¼‰ -->
 <script src="./libs/mediapipe/hands/hands.js"></script>
<script src="./libs/mediapipe/camera_utils/camera_utils.js"></script>

  <!-- å…œåº•ï¼šä¸ä¾èµ– moduleã€‚å³ä½¿ module import å¤±è´¥ï¼Œä¹Ÿèƒ½æç¤ºâ€œCDN è¢«æ‹¦æˆªâ€ã€‚ -->
  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const err = $("err"), btn = $("btn");
      const show = (t) => { err.style.display = "block"; err.textContent = t; };
      btn.addEventListener("click", () => {
        if (typeof window.initExperience === "function") window.initExperience();
        else show("å…³é”®è„šæœ¬æœªåŠ è½½ï¼šWi-Fi å¯èƒ½æ‹¦æˆªäº† unpkg/jsdelivr ç­‰ CDNã€‚å»ºè®®æ”¹ä¸º GitHub Pages åŒåŸŸè‡ªæ‰˜ç®¡ä¾èµ–ã€‚");
      }, { passive: true });
      setTimeout(() => {
        if (typeof window.initExperience !== "function") {
          show("æ£€æµ‹åˆ°æ¨¡å—è„šæœ¬æœªå°±ç»ªï¼ˆå¸¸è§åŸå› ï¼šCDN è¢«æ‹¦æˆª/ç½‘ç»œåŠ«æŒ/ç¦»çº¿ï¼‰ã€‚è¯·æ¢ç½‘ç»œæˆ–æ”¹ä¸ºåŒåŸŸè‡ªæ‰˜ç®¡ä¾èµ–ã€‚");
        }
      }, 2500);
    })();
  </script>

  <script type="module">
    // ç§»åŠ¨ç«¯å…¼å®¹å…³é”®ç‚¹ï¼š
    // 1) ä¸ç”¨ importmapï¼Œç›´æ¥ç”¨å®Œæ•´ ESM URLï¼ˆiOS Safari å¯¹ importmap æ”¯æŒä¸ç¨³ï¼‰
    // 2) æ‰€æœ‰å…¥å£æŒ‚åˆ° windowï¼Œä¾¿äºé module å…œåº•è„šæœ¬è°ƒç”¨
   import * as THREE from './libs/three/three.module.js';
import { EffectComposer } from './libs/three/examples/jsm/postprocessing/EffectComposer.js';
import { RenderPass } from './libs/three/examples/jsm/postprocessing/RenderPass.js';


    const $ = (id) => document.getElementById(id);
    const st = $("st"), overlay = $("overlay"), btn = $("btn");
    const video = $("v"), pointer = $("p"), file = $("file");

    let scene, camera, renderer, composer, group, star;
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const texLoader = new THREE.TextureLoader();
    const particles = [];
    const boxes = [];
    let selected = null, state = "tree";

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    const setStatus = (t) => st.textContent = t;

    function emojiTex(emoji) {
      const c = document.createElement("canvas");
      c.width = c.height = 64;
      const g = c.getContext("2d");
      g.font = "50px serif";
      g.textAlign = "center";
      g.textBaseline = "middle";
      g.fillText(emoji, 32, 32);
      const t = new THREE.CanvasTexture(c);
      t.colorSpace = THREE.SRGBColorSpace;
      return t;
    }

    function init3D() {
      scene = new THREE.Scene();
      group = new THREE.Group();
      scene.add(group);

      camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 0.1, 1000);
      camera.position.set(0, 12, 45);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(Math.min(devicePixelRatio || 1, 2));
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      $("c").appendChild(renderer.domElement);

      composer = new EffectComposer(renderer);
      composer.addPass(new RenderPass(scene, camera));

      scene.add(new THREE.AmbientLight(0xffffff, 0.85));

      // é¡¶éƒ¨æ˜Ÿæ˜Ÿï¼ˆç”¨ç®€åŒ– Shapeï¼›å‡å°‘ä¾èµ–ä¸ä½“é‡ï¼‰
      const s = new THREE.Shape();
      for (let i = 0; i < 10; i++) {
        const a = i * Math.PI / 5 - Math.PI / 2;
        const r = i % 2 === 0 ? 2.6 : 1.2;
        (i ? s.lineTo : s.moveTo).call(s, Math.cos(a) * r, Math.sin(a) * r);
      }
      star = new THREE.Mesh(new THREE.ExtrudeGeometry(s, { depth: 0.35, bevelEnabled: false }),
        new THREE.MeshBasicMaterial({ color: 0xFFD700 }));
      star.position.y = 17;
      group.add(star);

      // ç²’å­æ•°é‡ç§»åŠ¨ç«¯é€‚å½“é™ä½ï¼Œå‡å°‘å¡é¡¿
      const N = isMobile ? 180 : 260;
      const maps = [emojiTex("â­"), emojiTex("ğŸ„"), emojiTex("ğŸ")];
      for (let i = 0; i < N; i++) {
        const sp = new THREE.Sprite(new THREE.SpriteMaterial({ map: maps[i % 3], transparent: true }));
        sp.scale.set(0.8, 0.8, 1);

        const y = Math.random() * 25 - 10;
        const rr = (1 - (y + 10) / 25) * 11 + 0.5;
        const th = y * 1.2 + Math.random() * Math.PI * 2;

        sp.userData.tree = new THREE.Vector3(rr * Math.cos(th), y, rr * Math.sin(th));
        sp.userData.scatter = new THREE.Vector3((Math.random() - .5) * 60, (Math.random() - .5) * 60, (Math.random() - .5) * 60);
        sp.position.copy(sp.userData.tree);

        group.add(sp);
        particles.push(sp);
      }

      file.addEventListener("change", onUpload, { passive: true });
      animate();
    }

    function switchState(next) {
      if (state === next) return;
      state = next;
      const to = (p, t) => { p.position.lerp(t, 0.08); }; // ç®€åŒ–ï¼šç”¨ lerp ä»£æ›¿ gsapï¼ˆå‡å°‘ä¾èµ–ä¸ä½“é‡ï¼‰
      // åœ¨ animate é‡Œé€å¸§ lerp
      particles.forEach(p => p.userData.target = (next === "tree" ? p.userData.tree : p.userData.scatter));
      particles.forEach(p => to(p, p.userData.target));
    }

    function checkHit() {
      raycaster.setFromCamera(mouse, camera);
      const hit = raycaster.intersectObjects(boxes, false);
      const box = hit[0]?.object || null;
      if (box === selected) return;

      // è¿˜åŸæ—§çš„
      if (selected) {
        selected.position.copy(selected.userData.origin);
        selected.scale.set(1, 1, 1);
        selected.rotation.set(0, 0, 0);
      }
      selected = box;

      // æ”¾å¤§æ–°çš„
      if (selected) {
        selected.position.set(0, 10, 25);
        selected.scale.set(4.5, 4.5, 4.5);
        selected.rotation.y = Math.PI * 2;
      }
    }

    function onUpload(e) {
      const files = e.target.files;
      if (!files?.length) return;

      for (const f of files) {
        const url = URL.createObjectURL(f);
        texLoader.load(url, (tex) => {
          tex.colorSpace = THREE.SRGBColorSpace;
          const m = new THREE.MeshStandardMaterial({ map: tex });
          const box = new THREE.Mesh(new THREE.BoxGeometry(3.5, 3.5, 3.5), m);

          const t = Math.random();
          const y = t * 22 - 7;
          const r = (1 - t) * 11 + 3.5;
          const pos = new THREE.Vector3(r * Math.cos(t * 22), y, r * Math.sin(t * 22));

          box.position.set(0, -30, 0);
          box.userData.origin = pos.clone();
          group.add(box);
          boxes.push(box);

          URL.revokeObjectURL(url); // ç§»åŠ¨ç«¯å…³é”®ï¼šé‡Šæ”¾å†…å­˜
        }, undefined, () => URL.revokeObjectURL(url));
      }

      e.target.value = ""; // å…è®¸é‡å¤é€‰æ‹©åŒä¸€å¼ å›¾
    }

    async function initMediaPipe() {
      const HandsLib = window.Hands || window.mediapipe?.hands?.Hands;
      if (!HandsLib) { setStatus("MP_FAIL"); return; }
      if (!window.Camera) { setStatus("CAM_UTIL_FAIL"); return; }

     const hands = new HandsLib({
  locateFile: (file) => `./libs/mediapipe/hands/${file}`
});
`




