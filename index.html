<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Gesture Christmas Tree</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        
        /* å¯åŠ¨é®ç½©å±‚ */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #FFD700; transition: opacity 0.5s;
        }
        .start-btn {
            padding: 15px 40px; border: 2px solid #FFD700; background: transparent;
            color: #FFD700; font-size: 18px; cursor: pointer; border-radius: 30px;
            font-weight: bold; box-shadow: 0 0 15px #FFD700;
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; }
        .hud-text { color: #FFD700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); text-transform: uppercase; font-size: 12px; font-weight: bold; }
        .input_video { position: absolute; top: 15px; right: 15px; width: 100px; height: 75px; border-radius: 8px; opacity: 0.6; transform: scaleX(-1); border: 1px solid #FFD700;}
        #music-container { position: absolute; bottom: 15px; left: 15px; z-index: 100; pointer-events: auto; visibility: hidden; }
    </style>
</head>
<body>

    <div id="overlay">
        <h2 style="margin-bottom: 20px;">ğŸ„ 3D Gesture Magic ğŸ„</h2>
        <button class="start-btn" onclick="startExperience()">å¼€å¯åœ£è¯æƒŠå–œ</button>
        <p style="margin-top: 20px; font-size: 12px; opacity: 0.8;">è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥ä½“éªŒæ‰‹åŠ¿äº¤äº’</p>
    </div>

    <video class="input_video" playsinline></video>
    
    <div id="ui-layer">
        <div class="hud-text">Status: <span id="mode-text">Ready</span></div>
        <div style="text-align: center; margin-bottom: 80px; pointer-events: auto;">
            <div class="hud-text" style="font-size: 10px;">âœŠ æåˆæ•£å¼€ | ğŸ– å¼ å¼€è¿˜åŸ</div>
        </div>
    </div>

    <div id="music-container">
        <iframe id="music-player" frameborder="no" border="0" marginwidth="0" marginheight="0" width="280" height="52" 
            src="https://music.163.com/outchain/player?type=2&id=2657777735&auto=1&height=32">
        </iframe>
    </div>

    <canvas id="hand-cursor" style="position: absolute; width: 20px; height: 20px; border: 2px solid #FFD700; border-radius: 50%; display: none; z-index: 1000; pointer-events: none;"></canvas>
    <div id="canvas-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "gsap": "https://unpkg.com/gsap@3.12.5/index.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import gsap from 'gsap';

        let scene, camera, renderer, composer, snowSystem, particles = [], currentState = 'tree';

        window.startExperience = function() {
            // 1. éšè—é®ç½©
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('overlay').style.display = 'none', 500);
            
            // 2. æ˜¾ç¤ºå¹¶æ¿€æ´»éŸ³ä¹
            const music = document.getElementById('music-container');
            music.style.visibility = 'visible';
            
            // 3. åˆå§‹åŒ– 3D å’Œ æ‰‹åŠ¿
            init();
        }

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.02);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 40);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const renderPass = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.85);
            composer = new EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(bloomPass);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            createSnow();
            createTreeParticles();
            initMediaPipe();
            animate();
        }

        function createSnow() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 1500; i++) vertices.push(Math.random() * 100 - 50, Math.random() * 100 - 50, Math.random() * 100 - 50);
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            snowSystem = new THREE.Points(geometry, new THREE.PointsMaterial({ color: 0xffffff, size: 0.15, transparent: true, opacity: 0.6 }));
            scene.add(snowSystem);
        }

        function createTreeParticles() {
            const sphere = new THREE.SphereGeometry(0.3, 8, 8);
            const mats = [
                new THREE.MeshStandardMaterial({ color: 0xFFD700, metalness: 0.9 }), 
                new THREE.MeshStandardMaterial({ color: 0x8B0000 }), 
                new THREE.MeshStandardMaterial({ color: 0x2F4F4F })
            ];
            for (let i = 0; i < 350; i++) {
                const mesh = new THREE.Mesh(sphere, mats[i % 3]);
                const y = (Math.random() * 25) - 10;
                const r = (1 - (y + 10) / 25) * 10 + 0.5;
                const theta = y * 1.5 + Math.random() * Math.PI * 2;
                mesh.userData.treePos = new THREE.Vector3(r * Math.cos(theta), y, r * Math.sin(theta));
                mesh.userData.scatterPos = new THREE.Vector3((Math.random()-0.5)*50, (Math.random()-0.5)*50, (Math.random()-0.5)*50);
                mesh.position.copy(mesh.userData.treePos);
                scene.add(mesh);
                particles.push(mesh);
            }
        }

        async function initMediaPipe() {
            const videoElement = document.querySelector('.input_video');
            if (!window.Hands) return;
            const hands = new window.Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const pts = results.multiHandLandmarks[0];
                    const dist = Math.hypot(pts[8].x - pts[4].x, pts[8].y - pts[4].y);
                    switchState(dist < 0.07 ? 'scatter' : 'tree');
                }
            });
            const cameraPipe = new window.Camera(videoElement, {onFrame: async () => await hands.send({image: videoElement}), width: 640, height: 480});
            cameraPipe.start();
        }

        function switchState(next) {
            if(currentState === next) return;
            currentState = next;
            particles.forEach((p, i) => {
                const target = next === 'tree' ? p.userData.treePos : p.userData.scatterPos;
                gsap.to(p.position, { x: target.x, y: target.y, z: target.z, duration: 1.2, delay: i * 0.001 });
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            if(snowSystem) snowSystem.position.y -= 0.02;
            if(currentState === 'tree') scene.rotation.y += 0.005;
            composer.render();
        }
    </script>
</body>
</html>

